<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EmpanadApp ü•ü</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#fffaf2;
      --surface:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#ffb703;      /* amarillo empanada */
      --brand-2:#fb8500;    /* naranja tosti√≥n */
      --ok:#06d6a0;
      --warn:#ef476f;
      --info:#219ebc;
      --ring: 0 0 0 4px rgba(251,133,0,.15);
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:linear-gradient(180deg,var(--bg),#fff);
    }

    /* App Shell */
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:12px;
      padding:14px 18px env(safe-area-inset-right) 14px env(safe-area-inset-left);
      background:linear-gradient(180deg,#ffe29a 0%, #ffd166 100%);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .logo{
      width:34px;height:34px; border-radius:50%;
      background: radial-gradient(120% 120% at 20% 10%, #ffe29a 0%, #ffbb55 70%, #fb8500 100%);
      display:grid; place-items:center; color:#703b00; font-weight:900;
      box-shadow: inset 0 2px 4px rgba(255,255,255,.6), inset 0 -2px 6px rgba(0,0,0,.08);
    }
    .brand{ font-weight:800; letter-spacing:.2px; }
    main{ max-width:980px; margin:16px auto; padding:0 12px 24px; }
    .card{
      background:var(--surface); border-radius:var(--radius);
      box-shadow: var(--shadow); padding:16px; margin:12px 0;
    }
    /* Forms */
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    label{ font-size:.9rem; color:var(--muted) }
    input,button,textarea,select{
      width:100%;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      font:inherit;
      background:#ffffff;  /* ‚Üê Corregido */
      color:var(--text);   /* ‚Üê Asegura contraste legible */
    }
    input:focus, textarea:focus, select:focus{
      outline:none;
      box-shadow:var(--ring);
      border-color:#f59e0b;
    }
    button{
      cursor:pointer;
      border:0;
      font-weight:700;
      background:var(--brand-2);
      color:#2b1600;
      transition: transform .02s ease, box-shadow .2s ease;
      box-shadow: 0 6px 16px rgba(251,133,0,.25);
    }
    button:active{ transform: translateY(1px) }
    .secondary{ background:var(--info); color:#fff; }
    .ghost{ background:transparent; border:1px dashed #e5e7eb; color:var(--muted) }
    .ok{ background:var(--ok); color:#053b2f }
    .warn{ background:var(--warn); color:#fff }

    /* Table */
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:12px 8px; border-bottom:1px solid #f1f5f9; font-size:.95rem }
    th{ text-align:left; color:#475569 }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; }
    .status-pending{ background:#fff2c6 }
    .status-half{ background:#e0f2fe }
    .status-settled{ background:#dcfce7 }

    .muted{ color:var(--muted); font-size:.9rem }
    .space{ height:4px }

    /* Nav for app view */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    .hello{ font-weight:800 }
    .kebab{ font-size:1.15rem; background:transparent; border:0; padding:8px; }

    /* Responsive */
    @media (min-width:720px){
      .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    }
    @media (min-width:980px){
      main{ padding:0 16px 32px }
    }

    /* Tabs on auth */
    .tabs{ display:flex; gap:8px; background:#fff; border-radius:12px; padding:6px; box-shadow: var(--shadow); }
    .tab{
      flex:1; text-align:center; font-weight:800; padding:10px 12px; border-radius:10px;
      border:1px solid transparent; background: #fff7ed;
    }
    .tab.active{ background:#ffedd5; border-color:#fed7aa }

    /* Toast */
    .toast{
      position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background:#111827; color:#fff; padding:12px 16px; border-radius:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px) }

    /* Hide/Show views */
    [hidden]{ display:none !important }
  </style>
</head>
<body>
  <header>
    <div class="logo">ü•ü</div>
    <div class="brand">EmpanadApp</div>
  </header>

  <main>
    <!-- ========== VISTA 1: AUTENTICACI√ìN ========== -->
    <section id="view-auth" class="card">
      <div class="stack" style="gap:14px">
        <h2 style="margin:0">Bienvenido üëã</h2>
        <p class="muted" style="margin:0">
          Reg√≠strate o inicia sesi√≥n con tu <strong>llave de 6 caracteres</strong> (comparte esta llave con tus amigos para enviar/solicitar empanadas).
        </p>

        <div class="tabs" role="tablist">
          <button id="tab-login" class="tab active" role="tab" aria-selected="true">Iniciar sesi√≥n</button>
          <button id="tab-register" class="tab" role="tab" aria-selected="false">Registrarse</button>
        </div>

        <!-- Login -->
        <div id="pane-login" class="stack">
          <label for="llaveLogin">Llave (6 caracteres)</label>
          <input id="llaveLogin" inputmode="latin" maxlength="6" placeholder="EJEMPLO: AREPA1" autocomplete="one-time-code" />
          <button id="btnLogin" class="ok">Entrar</button>
        </div>

        <!-- Register -->
        <div id="pane-register" class="stack" hidden>
          <label for="fullName">Nombre completo</label>
          <input id="fullName" placeholder="Sof√≠a P√©rez" />
          <label for="llave">Elige tu llave (6 caracteres A-Z/0-9)</label>
          <input id="llave" inputmode="latin" maxlength="6" placeholder="AREPA1" />
          <button id="btnRegister">Crear cuenta</button>
        </div>

        <p id="meAuth" class="muted"></p>
      </div>
    </section>

    <!-- ========== VISTA 2: APP ========== -->
    <section id="view-app" hidden>
      <div class="topbar">
        <div>
          <div class="hello" id="helloUser">Hola üëã</div>
          <div class="muted" id="helloLlave"></div>
        </div>
        <div style="display:flex; gap:8px">
          <button id="btnIrStats" class="ghost">Estad√≠sticas</button>
          <button id="btnSalir" class="ghost">Salir</button>
        </div>
      </div>

      <div class="grid-2">
        <section class="card">
          <h3 style="margin-top:0">Enviar empanada pendiente</h3>
          <div class="stack">
            <label for="toLlave">Llave del receptor</label>
            <input id="toLlave" maxlength="6" placeholder="Ej: TACO42" />
            <div class="row">
              <div style="flex:1">
                <label for="sendQty">Cantidad</label>
                <input id="sendQty" type="number" inputmode="numeric" value="1" min="1" />
              </div>
              <div style="flex:3">
                <label for="sendMsg">Mensaje (opcional)</label>
                <input id="sendMsg" placeholder="Por las fotocopias üôè" />
              </div>
            </div>
            <button id="btnSend">Enviar</button>
          </div>
        </section>

        <section class="card">
          <h3 style="margin-top:0">Solicitar empanada</h3>
          <div class="stack">
            <label for="fromLlave">P√≠desela a (llave)</label>
            <input id="fromLlave" maxlength="6" placeholder="Ej: AREPA1" />
            <div class="row">
              <div style="flex:1">
                <label for="reqQty">Cantidad</label>
                <input id="reqQty" type="number" inputmode="numeric" value="1" min="1" />
              </div>
              <div style="flex:3">
                <label for="reqMsg">Mensaje (opcional)</label>
                <input id="reqMsg" placeholder="Por el favorcito de ayer üëÄ" />
              </div>
            </div>
            <button id="btnRequest" class="secondary">Solicitar</button>
          </div>
        </section>
      </div>

      <section class="card">
        <h3 style="margin-top:0">Tus estad√≠sticas</h3>
        <div id="stats" class="stack"></div>
      </section>

      <section class="card">
        <h3 style="margin-top:0">Tus deudas</h3>
        <div class="space"></div>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Qui√©n debe a qui√©n</th>
              <th>Cant.</th>
              <th>Mensaje</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="debts"></tbody>
        </table>
      </section>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Utilidades =====
    const $ = (s)=>document.querySelector(s);
    const show = (el)=> el.removeAttribute('hidden');
    const hide = (el)=> el.setAttribute('hidden','');
    const LLAVE_RE = /^[A-Z0-9]{6}$/;
    function up(s){ return String(s||'').trim().toUpperCase(); }
    function toast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      clearTimeout(window.__toast); window.__toast = setTimeout(()=> t.classList.remove('show'), 2100);
    }
    function fmtDate(iso){ try{ return new Date(iso).toLocaleString(); }catch{return iso} }
    let me = null;
    const authHeaders = ()=> me ? {'X-LLAVE': me.llave } : {};

    // ===== Navegaci√≥n de vistas =====
    function gotoApp(){
      hide($('#view-auth')); show($('#view-app'));
      $('#helloUser').textContent = `Hola, ${me.full_name} üëã`;
      $('#helloLlave').textContent = `Tu llave: ${me.llave}`;
      renderAll();
    }
    function gotoAuth(){
      show($('#view-auth')); hide($('#view-app'));
    }

    // ===== Tabs Auth =====
    const tabLogin = $('#tab-login');
    const tabRegister = $('#tab-register');
    const paneLogin = $('#pane-login');
    const paneRegister = $('#pane-register');
    tabLogin.onclick = ()=>{ tabLogin.classList.add('active'); tabRegister.classList.remove('active'); paneLogin.hidden=false; paneRegister.hidden=true; };
    tabRegister.onclick = ()=>{ tabRegister.classList.add('active'); tabLogin.classList.remove('active'); paneRegister.hidden=false; paneLogin.hidden=true; };

    // ===== API =====
    async function api(path, options={}){
      const r = await fetch(path, options);
      let body = null;
      try { body = await r.json(); } catch {}
      if(!r.ok) throw new Error((body && body.error) || `Error HTTP ${r.status}`);
      return body;
    }

    // ===== Auth =====
    async function login(){
      const llave = up($('#llaveLogin').value);
      if(!LLAVE_RE.test(llave)) return toast('La llave debe tener 6 caracteres A-Z/0-9');
      try{
        me = await api('/api/users/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({llave}) });
        localStorage.setItem('llave', me.llave);
        $('#meAuth').textContent = `Sesi√≥n iniciada como ${me.full_name} (${me.llave})`;
        toast('¬°Bienvenido!');
        gotoApp();
      }catch(e){ toast(e.message); }
    }

    async function register(){
      const full_name = $('#fullName').value.trim();
      const llave = up($('#llave').value);
      if(!full_name) return toast('Ingresa tu nombre completo');
      if(!LLAVE_RE.test(llave)) return toast('La llave debe tener 6 caracteres A-Z/0-9');
      try{
        me = await api('/api/users/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({full_name, llave}) });
        localStorage.setItem('llave', me.llave);
        $('#meAuth').textContent = `Registrado como ${me.full_name} (${me.llave})`;
        toast('¬°Cuenta creada!');
        gotoApp();
      }catch(e){ toast(e.message); }
    }

    // ===== Deudas =====
    function statusPill(d){
      if(d.settled_at) return '<span class="pill status-settled">pagada</span>';
      if(d.sender_marked_paid || d.recipient_marked_paid) return '<span class="pill status-half">a confirmar</span>';
      return '<span class="pill status-pending">pendiente</span>';
    }

    async function listDebts(){
      if(!me) return;
      try{
        const debts = await api('/api/debts', { headers: authHeaders() });
        $('#debts').innerHTML = debts.map(d => `
          <tr>
            <td>${fmtDate(d.created_at)}</td>
            <td>
              <strong>${d.sender.full_name} (${d.sender.llave})</strong>
              debe a
              <strong>${d.recipient.full_name} (${d.recipient.llave})</strong>
            </td>
            <td>${d.qty}</td>
            <td>${d.message? d.message.replace(/</g,'&lt;') : ''}</td>
            <td>${statusPill(d)}</td>
            <td>
              ${!d.settled_at ? `<button data-id="${d.id}" class="mark ok">Marcar pagada</button>` : ''}
              ${(!d.settled_at && ((d.sender.llave===me.llave && d.sender_marked_paid) || (d.recipient.llave===me.llave && d.recipient_marked_paid))) ? `<button data-id="${d.id}" class="unmark warn">Deshacer mi marca</button>` : ''}
            </td>
          </tr>
        `).join('');

        document.querySelectorAll('button.mark').forEach(b=>b.onclick = async ()=>{
          const id = b.getAttribute('data-id');
          try{ await api(`/api/debts/${id}/mark`, { method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' } }); toast('Marcada como pagada'); renderAll(); }
          catch(e){ toast(e.message); }
        });

        document.querySelectorAll('button.unmark').forEach(b=>b.onclick = async ()=>{
          const id = b.getAttribute('data-id');
          try{ await api(`/api/debts/${id}/unmark`, { method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' } }); toast('Marca deshecha'); renderAll(); }
          catch(e){ toast(e.message); }
        });

      }catch(e){ toast(e.message); }
    }

    async function sendDebt(){
      const to_llave = up($('#toLlave').value);
      const qty = Math.max(1, parseInt($('#sendQty').value||'1',10));
      const message = $('#sendMsg').value.trim();
      if(!LLAVE_RE.test(to_llave)) return toast('La llave del receptor debe tener 6 caracteres');
      try{
        await api('/api/debts/send', { method:'POST', headers:{...authHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({to_llave, qty, message}) });
        $('#toLlave').value=''; $('#sendQty').value='1'; $('#sendMsg').value='';
        toast('Empanada enviada ü•ü');
        renderAll();
      }catch(e){ toast(e.message); }
    }

    async function requestDebt(){
      const from_llave = up($('#fromLlave').value);
      const qty = Math.max(1, parseInt($('#reqQty').value||'1',10));
      const message = $('#reqMsg').value.trim();
      if(!LLAVE_RE.test(from_llave)) return toast('La llave debe tener 6 caracteres');
      try{
        await api('/api/debts/request', { method:'POST', headers:{...authHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({from_llave, qty, message}) });
        $('#fromLlave').value=''; $('#reqQty').value='1'; $('#reqMsg').value='';
        toast('Solicitud enviada üì©');
        renderAll();
      }catch(e){ toast(e.message); }
    }

    async function loadStats(){
      if(!me) return $('#stats').innerHTML='';
      try{
        const s = await api('/api/stats/me', { headers: authHeaders() });
        const rows = Object.entries(s.perFriend).map(([ll, v]) =>
          `<tr><td>${v.name} (${ll})</td><td>${v.iOwe}</td><td>${v.oweMe}</td><td>${v.oweMe - v.iOwe}</td></tr>`
        ).join('');
        $('#stats').innerHTML = `
          <p><strong>Debo:</strong> ${s.iOwe} ‚Ä¢ <strong>Me deben:</strong> ${s.oweMe} ‚Ä¢ <strong>Neto:</strong> ${s.net}</p>
          <table>
            <thead><tr><th>Amigo</th><th>Debo</th><th>Me debe</th><th>Neto</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="4">Sin deudas pendientes üéâ</td></tr>'}</tbody>
          </table>`;
      }catch(e){ toast(e.message); }
    }

    async function renderAll(){ await Promise.all([listDebts(), loadStats()]); }

    // ===== Wire =====
    $('#btnLogin').onclick = login;
    $('#btnRegister').onclick = register;
    $('#btnSend').onclick = sendDebt;
    $('#btnRequest').onclick = requestDebt;
    $('#btnSalir').onclick = ()=>{ localStorage.removeItem('llave'); me=null; toast('Sesi√≥n cerrada'); gotoAuth(); };
    $('#btnIrStats').onclick = ()=>{ window.scrollTo({top:0, behavior:'smooth'}); toast('Arriba est√°n tus estad√≠sticas'); };

    // Autologin
    const saved = localStorage.getItem('llave');
    if(saved){
      // Intenta sesi√≥n directa para caer de una al dashboard
      (async()=>{ try{ me = await api('/api/users/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({llave: saved}) }); gotoApp(); }catch{} })();
    }
  </script>
</body>
</html>
